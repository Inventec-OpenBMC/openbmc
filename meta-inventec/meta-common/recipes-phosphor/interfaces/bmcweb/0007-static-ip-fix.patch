From 742d5c067a245faa09e96764d9ed7bb7547feb15 Mon Sep 17 00:00:00 2001
From: Ashwini Udupa <udupa.ashwini@inventec.com>
Date: Mon, 21 Jun 2021 12:11:40 -0700
Subject: [PATCH] Ip fix

---
 redfish-core/lib/ethernet.hpp | 34 ++++++++++++++++++++++++++++++++--
 1 file changed, 32 insertions(+), 2 deletions(-)

diff --git a/redfish-core/lib/ethernet.hpp b/redfish-core/lib/ethernet.hpp
index 48b69a2..fa85a34 100644
--- a/redfish-core/lib/ethernet.hpp
+++ b/redfish-core/lib/ethernet.hpp
@@ -617,8 +617,7 @@ inline bool ipv4VerifyIpAndGetBitcount(const std::string& ip,
     if (bytesInMask.size() != ipV4AddressSectionsCount)
     {
         return false;
-    }
-
+    }    
     if (bits != nullptr)
     {
         *bits = 0;
@@ -627,6 +626,7 @@ inline bool ipv4VerifyIpAndGetBitcount(const std::string& ip,
     char* endPtr;
     long previousValue = 255;
     bool firstZeroInByteHit;
+
     for (const std::string& byte : bytesInMask)
     {
         if (byte.empty())
@@ -1450,6 +1450,36 @@ class EthernetInterface : public Node
                     if (ipv4VerifyIpAndGetBitcount(*address))
                     {
                         addr = &(*address);
+                        BMCWEB_LOG_DEBUG << "IPv4 address - " << *addr;
+                        int firstbyte=1,i=0;
+                        char* endPtr;
+                        std::vector<std::string> bytesInMask;
+                        boost::split(bytesInMask, (*addr), boost::is_any_of("."));
+                        for (const std::string& byte : bytesInMask)
+                        {
+                           long value = std::strtol(byte.c_str(), &endPtr, 10);
+                           if (firstbyte)
+                           {
+                             if (value == 127)   //checking for loopback IP
+                             {
+                               messages::propertyValueTypeError(asyncResp->res, *address, pathString + "/Address");
+                               errorInEntry = true;
+                             }
+
+                             if (value >=224 && value <=239)     //checking for multicast IP
+                             {
+                               messages::propertyValueTypeError(asyncResp->res, *address, pathString + "/Address");
+                               errorInEntry = true;
+                             }
+                             firstbyte =0;
+                           }
+                           i++;
+                           if ( i==4 && value == 255)      //checking for broadcast IP
+                           {
+                               messages::propertyValueTypeError(asyncResp->res, *address, pathString + "/Address");
+                               errorInEntry = true;
+                           }
+                         }
                     }
                     else
                     {
-- 
2.7.4

